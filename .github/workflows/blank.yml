name: Web RDP (Guacamole) - Manual Init
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Setup Docker Environment
        run: |
          # ç—•è·¡æ¶ˆåŽ»ç”¨ãƒˆãƒ©ãƒƒãƒ—
          trap 'echo "ðŸ§¹ Cleaning up traces..."; docker kill $(docker ps -q) 2>/dev/null; docker rm $(docker ps -a -q) 2>/dev/null; docker volume rm $(docker volume ls -q) 2>/dev/null; docker system prune -af; echo "âœ… All traces removed."' EXIT

          docker network create act-net

          # 1. Windows VMèµ·å‹•
          docker run -d \
            --name windows \
            --network act-net \
            --privileged \
            --cap-add NET_ADMIN \
            --stop-timeout 120 \
            -e RAM_SIZE="3G" \
            -e CPU_CORES="2" \
            -e "USERNAME=Admin" \
            -e "PASSWORD=admin" \
            dockurr/windows

          # 2. MySQL èµ·å‹•
          docker run -d \
            --name mysql \
            --network act-net \
            -e MYSQL_ROOT_PASSWORD=guacamole \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=guacamole_password \
            mysql

          # MySQLèµ·å‹•å¾…æ©Ÿ
          echo "Waiting for MySQL to be ready..."
          until docker exec mysql mysqladmin ping -h localhost --silent; do sleep 2; done
          echo "MySQL is up."

          # --- [é‡è¦] Guacamole DBã®åˆæœŸåŒ–æ‰‹å‹•å®Ÿè¡Œ ---
          # è‡ªå‹•åˆæœŸåŒ–ãŒä¸å®‰å®šãªãŸã‚ã€Guacamoleã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã®SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›´æŽ¥MySQLã«æµã—è¾¼ã¿ã¾ã™
          echo "Initializing Guacamole Database Schema..."
          docker run --rm guacamole/guacamole /opt/guacamole/bin/initdb.sh --mysql | docker exec -i mysql mysql -uroot -pguacamole guacamole_db
          echo "âœ… Database Schema Initialized."

          # 3. Guacamole Daemon (guacd) èµ·å‹•
          docker run -d \
            --name guacd \
            --network act-net \
            guacamole/guacd

          # 4. Guacamole Web ã‚¢ãƒ—ãƒªèµ·å‹•
          docker run -d \
            --name guacamole \
            --network act-net \
            -e MYSQL_HOSTNAME=mysql \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=guacamole_password \
            guacamole/guacamole

          # Guacamole Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹èµ·å‹•å¾…æ©Ÿ
          echo "Waiting for Guacamole Web Interface..."
          until docker exec guacamole curl -s http://localhost:8080 > /dev/null; do sleep 2; done
          echo "Guacamole Web Interface is up."

          # --- 5. RDPæŽ¥ç¶šè¨­å®šã®æ³¨å…¥ ---
          # ä»Šå›žã¯æ‰‹å‹•åˆæœŸåŒ–æ¸ˆã¿ãªã®ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’çœç•¥ã—ã€å³åº§ã«è¨­å®šã‚’æ³¨å…¥ã—ã¾ã™
          
          # Windowsã‚³ãƒ³ãƒ†ãƒŠã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
          WIN_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' windows)
          echo "Detected Windows IP: $WIN_IP"

          # RDPæŽ¥ç¶šè¨­å®šã®æ³¨å…¥
          docker exec -i mysql mysql -uroot -pguacamole guacamole_db 2>/dev/null <<EOF
          INSERT INTO guacamole_connection (connection_name, protocol) VALUES ('Windows RDP', 'rdp');
          SET @conn_id = LAST_INSERT_ID();
          INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value) VALUES
          (@conn_id, 'hostname', '$WIN_IP'),
          (@conn_id, 'port', '3389'),
          (@conn_id, 'username', 'Admin'),
          (@conn_id, 'password', 'admin'),
          (@conn_id, 'disable-auth', 'true'),
          (@conn_id, 'ignore-cert', 'true');
          
          INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission) 
          VALUES (1, @conn_id, 'READ');
          EOF
          echo "âœ… Connection config injected successfully."

      # --- 6. Cloudflare Tunnel ---
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          trap 'docker kill $(docker ps -q) 2>/dev/null; docker rm $(docker ps -a -q) 2>/dev/null; docker system prune -af; echo "Cleanup Complete"; exit' EXIT
          
          cloudflared tunnel --url http://localhost:8080 --loglevel info > cf_output.txt 2>&1 &
          
          for i in {1..120}; do
            if grep -q "https://" cf_output.txt; then
              break
            fi
            echo "Waiting for tunnel URL... ($i/120)"
            sleep 5
          done

          URL=$(grep -oP 'https://[a-z0-9\-]+\.trycloudflare\.com' cf_output.txt | head -n 1)
          
          if [ -n "$URL" ]; then
            echo "### ðŸš€ Web RDP Access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ **URL:** $URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘¤ **User:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”‘ **Pass:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æŽ¥ç¶šå 'Windows RDP' ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            
            echo "--------------------------------------------------"
            echo "ACCESS URL: $URL"
            echo "USER: guacadmin / PASS: guacadmin"
            echo "--------------------------------------------------"
          else
            cat cf_output.txt
            echo "URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          while true; do sleep 60; done
