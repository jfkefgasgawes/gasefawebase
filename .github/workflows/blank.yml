name: Windows Web Desktop (Cloudflare Tunnel)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # --- 1. VNCã‚µãƒ¼ãƒãƒ¼ (UltraVNC) ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Install UltraVNC
        run: choco install ultravnc -y

      - name: Configure UltraVNC (Registry)
        run: |
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ 'admin' ã«è¨­å®š
          $regPath = "HKLM:\SOFTWARE\UltraVNC"
          if (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
          New-ItemProperty -Path $regPath -Name "passwd" -Value ([byte[]](0x21,0x78,0x96,0x2d,0x6f,0x7d,0x34,0x8c)) -PropertyType Binary -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "AllowLoopback" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "DebugLevel" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "LogIn" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "MSLogonRequired" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "AuthRequired" -Value 1 -PropertyType DWord -Force | Out-Null
          New-NetFirewallRule -DisplayName "UltraVNC" -Direction Inbound -LocalPort 5900 -Protocol TCP -Action Allow | Out-Null

      - name: Install and Start UltraVNC Service
        run: |
          $vncPath = (Get-ChildItem "C:\Program Files", "C:\Program Files (x86)" -Filter "winvnc.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          Write-Host "Found VNC at $vncPath"
          if (-not (Get-Service uvnc_service -ErrorAction SilentlyContinue)) {
            Start-Process $vncPath -ArgumentList "-installservice" -Wait
          }
          Start-Service uvnc_service
          Start-Sleep -Seconds 3
          Get-Service uvnc_service

      # --- 2. Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (noVNC + websockify) ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Install Python & Websockify
        run: pip install websockify

      - name: Download noVNC
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.zip" -OutFile "novnc.zip"
          Expand-Archive -Path "novnc.zip" -DestinationPath "C:\"
          Rename-Item -Path "C:\noVNC-1.4.0" -NewName "novnc"

      # --- 3. Cloudflare Tunnel ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Install Cloudflared
        run: choco install cloudflared -y

      # --- 4. èµ·å‹• ---
      # ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€æ–‡å­—åˆ—å‡ºåŠ›ã‚’ Add-Content ã«çµ±ä¸€ã—ã¾ã—ãŸ
      - name: Start Websockify & Cloudflare Tunnel
        shell: pwsh
        run: |
          $wsJob = Start-Job -ScriptBlock { 
            param($webPath)
            C:\Python*\Scripts\websockify.exe 8080 localhost:5900 --web=$webPath 2>&1 | Out-Host 
          } -ArgumentList "C:\novnc"

          $cfJob = Start-Job -ScriptBlock {
            cloudflared tunnel --url http://localhost:8080 --loglevel info 2>&1 | Out-File "C:\cf_output.log" -Append
          }

          Start-Sleep -Seconds 12

          $content = Get-Content "C:\cf_output.log" -Raw
          
          if ($content -match "https://[a-z0-9\-]+\.trycloudflare\.com") {
            $url = $matches[0]
            
            # å®‰å…¨ã«å‡ºåŠ›ã™ã‚‹ãŸã‚ã«å¤‰æ•°ã«æ ¼ç´ã—ã¦ã‹ã‚‰å‡ºåŠ›
            $summaryPath = $env:GITHUB_STEP_SUMMARY
            
            Add-Content -Path $summaryPath -Value "### ğŸ–¥ï¸ Windows Desktop (Cloudflare Tunnel)"
            Add-Content -Path $summaryPath -Value ""
            Add-Content -Path $summaryPath -Value "ğŸ‘‰ **URL:** $url"
            Add-Content -Path $summaryPath -Value "ğŸ”‘ **Password:** `admin`"
            Add-Content -Path $summaryPath -Value ""
            
            Write-Host "--------------------------------------------------"
            Write-Host "ACCESS URL: $url"
            Write-Host "PASSWORD:   admin"
            Write-Host "--------------------------------------------------"
          } else {
            cat "C:\cf_output.log"
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          }

          while($true) { Start-Sleep -Seconds 60 }
