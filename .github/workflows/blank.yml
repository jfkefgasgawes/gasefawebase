name: Web RDP (Guacamole) - Final Fix
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Setup Docker Environment
        run: |
          docker network create act-net

          # 1. Windows VMèµ·å‹•
          docker run -d \
            --name windows \
            --network act-net \
            --privileged \
            --cap-add NET_ADMIN \
            --stop-timeout 120 \
            -e RAM_SIZE="3G" \
            -e CPU_CORES="2" \
            -e "USERNAME=Admin" \
            -e "PASSWORD=admin" \
            dockurr/windows

          # 2. MySQL èµ·å‹•
          docker run -d \
            --name mysql \
            --network act-net \
            -e MYSQL_ROOT_PASSWORD=guacamole \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=guacamole_password \
            mysql

          # MySQLèµ·å‹•å¾…æ©Ÿ
          echo "Waiting for MySQL to be ready..."
          until docker exec mysql mysqladmin ping -h localhost --silent; do sleep 2; done
          echo "MySQL is up."

          # --- DBåˆæœŸåŒ– & æ¨©é™ä»˜ä¸Ž ---
          echo "Initializing Guacamole Database Schema..."
          docker run --rm guacamole/guacamole /opt/guacamole/bin/initdb.sh --mysql > init.sql
          docker exec -i mysql mysql -uroot -pguacamole guacamole_db < init.sql
          rm init.sql
          
          # æ¨©é™ä»˜ä¸Ž
          docker exec mysql mysql -uroot -pguacamole -e "GRANT ALL PRIVILEGES ON guacamole_db.* TO 'guacamole_user'@'%'; FLUSH PRIVILEGES;"
          echo "âœ… Database Initialized."

          # 3. Guacamole Daemon (guacd) èµ·å‹•
          docker run -d \
            --name guacd \
            --network act-net \
            guacamole/guacd

          # 4. Guacamole Web ã‚¢ãƒ—ãƒªèµ·å‹•
          docker run -d \
            --name guacamole \
            --network act-net \
            -p 8080:8080 \
            -e MYSQL_HOSTNAME=mysql \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=guacamole_password \
            guacamole/guacamole

          # Guacamole Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹èµ·å‹•å¾…æ©Ÿ
          echo "Waiting for Guacamole Web Interface..."
          # ãƒ«ãƒ¼ãƒˆ(/)ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã¯ãªãã€/guacamoleã¸ã®æŽ¥ç¶šç¢ºèªã¯curlã§ã¯é¢å€’ãªã®ã§ã€
          # å˜ç´”ã«ãƒãƒ¼ãƒˆ8080ãŒé–‹ãã®ã‚’å¾…ã¡ã¾ã™ï¼ˆGuacamoleã¯é‡ã„ãŸã‚ï¼‰
          sleep 15 
          until curl -s http://localhost:8080 > /dev/null; do sleep 2; done
          echo "Guacamole Web Interface is up."

          # 5. RDPæŽ¥ç¶šè¨­å®šã®æ³¨å…¥
          WIN_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' windows)
          echo "Detected Windows IP: $WIN_IP"

          docker exec -i mysql mysql -uroot -pguacamole guacamole_db 2>/dev/null <<EOF
          INSERT INTO guacamole_connection (connection_name, protocol) VALUES ('Windows RDP', 'rdp');
          SET @conn_id = LAST_INSERT_ID();
          INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value) VALUES
          (@conn_id, 'hostname', '$WIN_IP'),
          (@conn_id, 'port', '3389'),
          (@conn_id, 'username', 'Admin'),
          (@conn_id, 'password', 'admin'),
          (@conn_id, 'disable-auth', 'true'),
          (@conn_id, 'ignore-cert', 'true');
          
          INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission) 
          VALUES (1, @conn_id, 'READ');
          EOF
          echo "âœ… Connection config injected successfully."

      # --- 6. Cloudflare Tunnel ---
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 --loglevel info > cf_output.txt 2>&1 &
          
          for i in {1..120}; do
            if grep -q "https://" cf_output.txt; then
              break
            fi
            echo "Waiting for tunnel URL... ($i/120)"
            sleep 5
          done

          URL=$(grep -oP 'https://[a-z0-9\-]+\.trycloudflare\.com' cf_output.txt | head -n 1)
          
          if [ -n "$URL" ]; then
            echo "### ðŸš€ Web RDP Access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼šURLã®æœ«å°¾ã« /guacamole ã‚’è‡ªå‹•ã§ä»˜ã‘ã¾ã™
            echo "ðŸ‘‰ **URL:** $URL/guacamole" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘¤ **User:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”‘ **Pass:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æŽ¥ç¶šå 'Windows RDP' ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            
            echo "--------------------------------------------------"
            echo "ACCESS URL: $URL/guacamole"
            echo "USER: guacadmin / PASS: guacadmin"
            echo "--------------------------------------------------"
          else
            cat cf_output.txt
            echo "URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          while true; do sleep 60; done
