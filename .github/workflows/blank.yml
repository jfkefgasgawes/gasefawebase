name: Windows Web Desktop (Cloudflare Tunnel)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 # 6時間 (最大)
    
    steps:
      # --- 1. VNCサーバー (UltraVNC) のセットアップ ---
      - name: Install UltraVNC
        run: choco install ultravnc -y

      - name: Configure UltraVNC (Registry)
        run: |
          # パスワードを 'admin' に設定 (レジストリ直接操作)
          $regPath = "HKLM:\SOFTWARE\UltraVNC"
          if (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
          
          # パスワード: 'admin' (8文字固定のVNCパスワードハッシュ)
          New-ItemProperty -Path $regPath -Name "passwd" -Value ([byte[]](0x21,0x78,0x96,0x2d,0x6f,0x7d,0x34,0x8c)) -PropertyType Binary -Force | Out-Null
          
          # 基本設定
          New-ItemProperty -Path $regPath -Name "AllowLoopback" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "DebugLevel" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "LogIn" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "MSLogonRequired" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "AuthRequired" -Value 1 -PropertyType DWord -Force | Out-Null
          
          # ファイアウォール許可
          New-NetFirewallRule -DisplayName "UltraVNC" -Direction Inbound -LocalPort 5900 -Protocol TCP -Action Allow | Out-Null

      - name: Start UltraVNC Service
        run: |
          Restart-Service uvnc_service
          Start-Sleep -Seconds 3
          Get-Service uvnc_service

      # --- 2. Webインターフェース (noVNC + websockify) のセットアップ ---
      - name: Install Python & Websockify
        run: pip install websockify

      - name: Download noVNC
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.zip" -OutFile "novnc.zip"
          Expand-Archive -Path "novnc.zip" -DestinationPath "C:\"
          Rename-Item -Path "C:\noVNC-1.4.0" -NewName "novnc"

      # --- 3. Cloudflare Tunnel (cloudflared) のセットアップ ---
      - name: Install Cloudflared
        run: choco install cloudflared -y

      # --- 4. 起動 ---
      - name: Start Websockify & Cloudflare Tunnel
        run: |
          # noVNCのWebページを8080でホスト
          $env:PYTHONUNBUFFERED = "1"
          
          # Websockifyをバックグラウンドで起動 (8080 -> VNC:5900)
          # PowerShellのバックグラウンドジョブとして起動
          $wsJob = Start-Job -ScriptBlock { 
            param($webPath)
            C:\Python*\Scripts\websockify.exe 8080 localhost:5900 --web=$webPath --token-plugin=TokenAuthentication 2>&1 | Out-Host 
          } -ArgumentList "C:\novnc"

          # Cloudflare Tunnelを起動して8080番をWebへ公開
          # ログをファイルにリダイレクトしながら起動
          $cfJob = Start-Job -ScriptBlock {
            cloudflared tunnel --url http://localhost:8080 --loglevel info 2>&1 | Out-File "C:\cf_output.log" -Append
          }

          # URLが表示されるまで待機 (Cloudflare Tunnelは起動が早い)
          Start-Sleep -Seconds 10

          # ログからURLを抽出
          $content = Get-Content "C:\cf_output.log" -Raw
          
          # CloudflareのURLを抽出
          if ($content -match "https://[a-z0-9\-]+\.trycloudflare\.com") {
            $url = $matches[0]
            
            # GitHub Summaryに表示
            echo "### 🚀 Windows Desktop Access (Cloudflare Tunnel)" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "👉 **URL:** $url" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "🔑 **Password:** `admin`" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "注意: ページを開いた後、左上の接続ボタンを押してください。" >> $env:GITHUB_STEP_SUMMARY
            
            Write-Host "--------------------------------------------------"
            Write-Host "ACCESS URL: $url"
            Write-Host "PASSWORD:   admin"
            Write-Host "--------------------------------------------------"
          } else {
            cat "C:\cf_output.log"
            echo "URLの取得に失敗しました。" >> $env:GITHUB_STEP_SUMMARY
          }

          # ジョブが終了しないようにループ
          while($true) { Start-Sleep -Seconds 60 }
