name: Dockur Windows (Software Emulation / No-KVM)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      # --- 1. Dockur Windows コンテナの起動 ---
      - name: Start Dockur Windows Container
        run: |
          # GitHub Actionsの環境では /dev/kvm が使えないため削除しました
          # その代わり --privileged を使い、ソフトウェアエミュレーションで動かします
          docker run -d \
            --name windows \
            --privileged \
            --cap-add NET_ADMIN \
            --stop-timeout 120 \
            -p 8006:8006 \
            -e RAM_SIZE="3G" \
            -e CPU_CORES="2" \
            -e "VERSION=win11" \
            dockur/windows

      # --- 2. 起動待ち (Windowsがブートするまで待機) ---
      - name: Wait for Windows to Boot
        run: |
          echo "Waiting for Windows to start..."
          echo "⚠️ 注意: ソフトウェアエミュレーションのため、初回起動は非常に遅いです(10〜20分)。"
          
          # 8006ポートが開くまでポーリング (長めに待機)
          timeout 600 bash -c 'until nc -z localhost 8006; do sleep 10; done' || echo "Port check timed out, but proceeding..."
          echo "Port 8006 is open."

      # --- 3. Cloudflare Tunnel (cloudflared) のセットアップと起動 ---
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          # バックグラウンドでTunnelを起動
          cloudflared tunnel --url http://localhost:8006 --loglevel info > cf_output.txt 2>&1 &
          
          # URLが出力されるのを待つ
          for i in {1..120}; do
            if grep -q "https://" cf_output.txt; then
              echo "Tunnel URL found."
              break
            fi
            echo "Waiting for tunnel URL... ($i/120)"
            sleep 5
          done

          # ログからURLを抽出
          URL=$(grep -oP 'https://[a-z0-9\-]+\.trycloudflare\.com' cf_output.txt | head -n 1)
          
          if [ -n "$URL" ]; then
            echo "### 🚀 Dockur Windows Access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "👉 **URL:** $URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Performance:** Emulation Mode (Slow)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "----------------------------------------"
            echo "ACCESS URL: $URL"
            echo "----------------------------------------"
          else
            cat cf_output.txt
            echo "URLの取得に失敗しました。" >> $GITHUB_STEP_SUMMARY
          fi

          # ジョブが終了しないように無限ループ
          while true; do sleep 60; done
