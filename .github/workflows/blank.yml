name: Windows RDP Environment

on:
  workflow_dispatch: # 手動実行

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: RDP Setup
      run: |
        # 1. リモートデスクトップ機能を有効化
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        # ファイアウォールでRDPポート(3389)を許可
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # 2. ユーザー作成 (パスワードは必ず変更してください)
        # ユーザー名: admin, パスワード: P@ssw0rd123!
        $password = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force
        New-LocalUser -Name "admin" -Password $password -FullName "Administrator" -Description "RDP User"
        Add-LocalGroupMember -Group "Administrators" -Member "admin"

    - name: Download Bore
      run: |
        # Bore (アカウント不要のTCPトンネル) をダウンロード
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/download/v0.4.0/bore-v0.4.0-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive -Path "bore.zip" -DestinationPath "bore"

    - name: Start Tunnel and Keep Alive
      run: |
        # ローカルの3389ポートをbore.pub経由で公開
        # ログに表示される "bore.pub:xxxxx" が接続先アドレスです
        Write-Host "Starting RDP Tunnel..."
        ./bore/bore.exe local 3389 --to bore.pub
        
        # ジョブがkillされないようにスリープし続ける (最大6時間まで)
        # Ctrl+Cやキャンセルボタンで止めるまで動き続けます
        Start-Sleep -Seconds 21600
