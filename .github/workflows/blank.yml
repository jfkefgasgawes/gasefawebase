name: Web RDP (Guacamole) & Auto-Cleanup
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Setup Docker Environment
        run: |
          # å‰Šé™¤ç”¨ãƒˆãƒ©ãƒƒãƒ—: ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ã«å…¨ã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ç‰©ç†å‰Šé™¤
          trap 'echo "ğŸ§¹ Cleaning up traces..."; docker kill $(docker ps -q) 2>/dev/null; docker rm $(docker ps -a -q) 2>/dev/null; docker volume rm $(docker volume ls -q) 2>/dev/null; docker system prune -af; echo "âœ… All traces removed."' EXIT

          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œæˆ
          docker network create act-net

          # 1. Windows VMèµ·å‹• (RDPãƒãƒ¼ãƒˆ3389)
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å›ºå®š: admin / ãƒ¦ãƒ¼ã‚¶ãƒ¼: Admin
          docker run -d \
            --name windows \
            --network act-net \
            --privileged \
            --cap-add NET_ADMIN \
            --stop-timeout 120 \
            -e RAM_SIZE="3G" \
            -e CPU_CORES="2" \
            -e "USERNAME=Admin" \
            -e "PASSWORD=admin" \
            dockurr/windows

          # 2. Guacamoleç”¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (MySQL) èµ·å‹•
          docker run -d \
            --name mysql \
            --network act-net \
            -e MYSQL_ROOT_PASSWORD=guacamole \
            mysql

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èµ·å‹•å¾…æ©Ÿ
          echo "Waiting for MySQL..."
          until docker exec mysql mysqladmin ping -h localhost --silent; do sleep 2; done
          sleep 5

          # 3. Guacamole Daemon (guacd) èµ·å‹•
          docker run -d \
            --name guacd \
            --network act-net \
            guacamole/guacd

          # 4. Guacamole Web ã‚¢ãƒ—ãƒªèµ·å‹•
          docker run -d \
            --name guacamole \
            --network act-net \
            --link mysql:mysql \
            --link guacd:guacd \
            -e MYSQL_HOSTNAME=mysql \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=guacamole_password \
            -e MYSQL_ROOT_PASSWORD=guacamole \
            guacamole/guacamole

          # Guacamoleèµ·å‹•å¾…æ©Ÿ
          echo "Waiting for Guacamole..."
          sleep 10
          until docker exec guacamole curl -s http://localhost:8080 > /dev/null; do sleep 2; done
          echo "Guacamole is up."

          # --- 5. RDPæ¥ç¶šè¨­å®šã®è‡ªå‹•æ³¨å…¥ (ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œä¸è¦åŒ–) ---
          # Windowsã‚³ãƒ³ãƒ†ãƒŠã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
          WIN_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' windows)
          
          echo "Detected Windows IP: $WIN_IP"

          # Guacamoleã®DBã«ç›´æ¥æ¥ç¶šæƒ…å ±ã‚’INSERT (ãƒ¦ãƒ¼ã‚¶ãƒ¼: Admin, Pass: admin, Protocol: RDP)
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ 'guacadmin' ã§ã“ã®æ¥ç¶šã‚’åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
          docker exec -i mysql mysql -uroot -pguacamole guacamole_db <<EOF
          INSERT INTO guacamole_connection (connection_name, protocol) VALUES ('Windows RDP', 'rdp');
          SET @conn_id = LAST_INSERT_ID();
          INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value) VALUES
          (@conn_id, 'hostname', '$WIN_IP'),
          (@conn_id, 'port', '3389'),
          (@conn_id, 'username', 'Admin'),
          (@conn_id, 'password', 'admin'),
          (@conn_id, 'disable-auth', 'true'),
          (@conn_id, 'ignore-cert', 'true');
          
          -- guacadminãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã“ã®æ¥ç¶šæ¨©é™ã‚’ä»˜ä¸
          INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission) 
          VALUES (1, @conn_id, 'READ');
          EOF
          
          echo "âœ… Connection config injected."

      # --- 6. Cloudflare Tunnel ã§å…¬é–‹ ---
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          # èµ·å‹•æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—è¨­å®š
          trap 'docker kill $(docker ps -q) 2>/dev/null; docker rm $(docker ps -a -q) 2>/dev/null; docker system prune -af; echo "Cleanup Complete"; exit' EXIT
          
          # Guacamoleã®Web(8080)ã‚’Tunnelã§å…¬é–‹
          cloudflared tunnel --url http://localhost:8080 --loglevel info > cf_output.txt 2>&1 &
          TUNNEL_PID=$!
          
          # URLå–å¾—
          for i in {1..120}; do
            if grep -q "https://" cf_output.txt; then
              echo "Tunnel URL found."
              break
            fi
            echo "Waiting for tunnel URL... ($i/120)"
            sleep 5
          done

          URL=$(grep -oP 'https://[a-z0-9\-]+\.trycloudflare\.com' cf_output.txt | head -n 1)
          
          if [ -n "$URL" ]; then
            echo "### ğŸš€ Web RDP Access (Apache Guacamole)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘‰ **URL:** $URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘¤ **Guacamole User:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”‘ **Guacamole Pass:** \`guacadmin\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ–¥ï¸ **Connection Name:** \`Windows RDP\` (Already created)" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”‘ **Windows Pass:** \`admin\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Security:** å…¨ãƒ‡ãƒ¼ã‚¿ã¯æ¥ç¶šçµ‚äº†æ™‚ã«ç‰©ç†å‰Šé™¤ã•ã‚Œã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            
            echo "--------------------------------------------------"
            echo "ACCESS URL: $URL"
            echo "USER: guacadmin / PASS: guacadmin"
            echo "Click 'Windows RDP' to connect."
            echo "--------------------------------------------------"
          else
            cat cf_output.txt
            echo "URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          # æ¥ç¶šã‚’ç¶­æŒ
          while true; do sleep 60; done
