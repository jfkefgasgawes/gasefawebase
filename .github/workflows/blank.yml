name: Windows Web Desktop (Cloudflare Tunnel)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # --- 1. VNCサーバー (UltraVNC) のセットアップ ---
      - name: Install UltraVNC
        run: choco install ultravnc -y

      - name: Configure UltraVNC (Registry)
        run: |
          # パスワードを 'admin' に設定 (レジストリ直接操作)
          $regPath = "HKLM:\SOFTWARE\UltraVNC"
          if (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
          
          # パスワード: 'admin'
          New-ItemProperty -Path $regPath -Name "passwd" -Value ([byte[]](0x21,0x78,0x96,0x2d,0x6f,0x7d,0x34,0x8c)) -PropertyType Binary -Force | Out-Null
          
          # 設定変更
          New-ItemProperty -Path $regPath -Name "AllowLoopback" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "DebugLevel" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "LogIn" -Value 1 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "MSLogonRequired" -Value 0 -PropertyType DWord -Force | Out-Null
          New-ItemProperty -Path $regPath -Name "AuthRequired" -Value 1 -PropertyType DWord -Force | Out-Null
          
          # ファイアウォール許可
          New-NetFirewallRule -DisplayName "UltraVNC" -Direction Inbound -LocalPort 5900 -Protocol TCP -Action Allow | Out-Null

      # --- ここが修正箇所 ---
      - name: Install and Start UltraVNC Service
        run: |
          # winvnc.exeのパスを特定
          $vncPath = (Get-ChildItem "C:\Program Files", "C:\Program Files (x86)" -Filter "winvnc.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
          Write-Host "Found VNC at $vncPath"
          
          # サービスのインストール (まだ存在しない場合)
          if (-not (Get-Service uvnc_service -ErrorAction SilentlyContinue)) {
            Write-Host "Installing UltraVNC service..."
            Start-Process $vncPath -ArgumentList "-installservice" -Wait
          } else {
            Write-Host "Service already exists."
          }
          
          # サービスの開始
          Start-Service uvnc_service
          Start-Sleep -Seconds 3
          Get-Service uvnc_service
      # ---------------------

      # --- 2. Webインターフェース (noVNC + websockify) のセットアップ ---
      - name: Install Python & Websockify
        run: pip install websockify

      - name: Download noVNC
        run: |
          Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.zip" -OutFile "novnc.zip"
          Expand-Archive -Path "novnc.zip" -DestinationPath "C:\"
          Rename-Item -Path "C:\noVNC-1.4.0" -NewName "novnc"

      # --- 3. Cloudflare Tunnel (cloudflared) のセットアップ ---
      - name: Install Cloudflared
        run: choco install cloudflared -y

      # --- 4. 起動と接続 ---
      - name: Start Websockify & Cloudflare Tunnel
        shell: pwsh
        run: |
          # Websockifyをバックグラウンドで起動 (localhost:8080 -> localhost:5900)
          $wsJob = Start-Job -ScriptBlock { 
            param($webPath)
            C:\Python*\Scripts\websockify.exe 8080 localhost:5900 --web=$webPath 2>&1 | Out-Host 
          } -ArgumentList "C:\novnc"

          # Cloudflare Tunnelを起動
          # ログをファイルに出力しつつ実行
          $cfJob = Start-Job -ScriptBlock {
            cloudflared tunnel --url http://localhost:8080 --loglevel info 2>&1 | Out-File "C:\cf_output.log" -Append
          }

          # URLが出力されるのを待つ
          Start-Sleep -Seconds 10

          # ログからURLを抽出して表示
          $content = Get-Content "C:\cf_output.log" -Raw
          
          if ($content -match "https://[a-z0-9\-]+\.trycloudflare\.com") {
            $url = $matches[0]
            
            # GitHub Summaryにリンクを表示
            echo "### 🖥️ Windows Desktop (Cloudflare Tunnel)" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "👉 **URL:** $url" >> $env:GITHUB_STEP_SUMMARY
            echo "🔑 **Password:** `admin`" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            
            Write-Host "--------------------------------------------------"
            Write-Host "ACCESS URL: $url"
            Write-Host "PASSWORD:   admin"
            Write-Host "--------------------------------------------------"
          } else {
            # URLが見つからなかった場合、ログを出力してデバッグ
            cat "C:\cf_output.log"
            echo "URLの取得に失敗しました。" >> $env:GITHUB_STEP_SUMMARY
          }

          # ジョブが終了しないように永遠にスリープ
          while($true) { Start-Sleep -Seconds 60 }
